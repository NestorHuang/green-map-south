# 功能規格書 (Functional Specs)

本文件詳述系統 A, B, C 三大模組的具體功能規格。

## 模組 A: 地圖與搜尋 (Map & Search)
此為使用者查找資訊的核心介面。

| ID   | 功能規格描述 (依據 Q&A 決議) |
| :--- | :--- |
| **F-A1** | **互動地圖初始化**<br> **平台類型**: PWA (Web App)，使用 **Google Maps Platform**。<br> **地圖邏輯**: 必須採用 **GPS 優先** 邏輯。<br> 1. (優先) 請求 `navigator.geolocation` 取得使用者 GPS。<br> 2. (預設) 若失敗，預設中心點為「高雄市火車站」。<br> 3. **縮放尺度**: 初始地圖縮放等級應顯示中心點半徑約 500 公尺的範圍。<br> 4. **API 載入**: Google Maps API 腳本在應用程式啟動時於頂層統一載入，確保跨頁面導航時的穩定性。 |
| **F-A2** | *(待補充)* |
| **F-A3** | **地點詳情互動介面**<br> **模式**: 必須採用「**資訊面板模式 (Bottom Sheet)**」。<br> 1. 使用者點擊地圖上的圖釘 (Pin)。<br> 2. **禁止**彈出傳統小資訊卡或跳轉頁面。<br> 3. 應由螢幕下方滑出「資訊面板」，直接顯示 F-A3 的完整詳情。 |
| **F-A4** | **關鍵字搜尋**<br>1. 在 Header UI 中提供一個文字輸入框。<br>2. 使用 **Google Places Autocomplete** 服務，使用者輸入文字時，動態提供地點建議。<br>3. 使用者選擇地點後，地圖中心點會移動到該地點，並放大顯示。<br>4. **注意**: Google Places Autocomplete 服務目前會顯示棄用警告 (`google.maps.places.Autocomplete is not available to new customers...`)，此為第三方函式庫內部問題，不影響功能，待函式庫更新。 |
| **F-A5** | **分類與標籤篩選**<br>1. 在 Header UI 中提供一組標籤按鈕。<br>2. 點擊標籤按鈕後，地圖應只顯示包含該標籤的地點。<br>3. 需提供「清除篩選」的選項。 |
| **F-A6** | **標記點棄用警告**<br>目前使用的 `google.maps.Marker` 會顯示棄用警告 (`google.maps.Marker is deprecated...`)。此為第三方函式庫內部問題，不影響功能，待函式庫更新或未來版本升級時替換為 `AdvancedMarkerElement`。 |
| **F-A-RWD** | **響應式介面 (RWD)**<br>應用程式的所有核心介面均已進行響應式設計優化。<br>1. **Header**: 在手機版視圖下，導覽選項（如登入、上傳）會收合在一個漢堡選單中，確保搜尋和篩選功能的可見性。<br>2. **管理後台**: 在手機版視圖下，側邊導覽列會預設隱藏，並可透過漢堡選單按鈕喚出，以適應較小的螢幕寬度。 |

## 模組 B: 伙伴貢獻 (Partner Contribution)
此為「綠活伙伴」貢獻資料的核心功能。

| ID   | 功能規格描述 |
| :--- | :--- |
| **F-B1** | **地點登錄 (動態類型)**<br>1. 提供一個 `/register` 頁面，採用多步驟精靈介面 (Wizard UI)。<br>2. **步驟 1**: 選擇地點類型（如：團集會場地、綠生活店家），顯示類型圖示與描述。<br>3. **步驟 2**: 填寫基本資訊（名稱、地址、描述、照片、標籤）。<br>4. **步驟 3**: 填寫類型專屬的動態欄位（依據該類型的配置自動生成表單）。<br>   - 支援文字、數字（含單位顯示）、多選、單選等多元輸入。<br>5. 系統使用 **Google Maps Geocoding API** 將地址轉換為地理座標。<br>6. 提交的資料會進入 `pending_locations` 集合等待審核。 |
| **F-B1 Auth** | **社交帳號登入**<br>1. 提供 Google 帳號快速登入選項。<br>2. 登入後，UI 應顯示使用者資訊（荒野夥伴顯示為「自然名(團名)」，一般使用者顯示姓名）。<br>3. 提供登出選項與個人資料編輯入口。 |
| **F-B1 Photos**| **多圖片上傳**<br>1. 支援上傳最多 10 張圖片。<br>2. 圖片應上傳至 Firebase Storage，並將所有 URL 存入 `photoURLs` 陣列。<br>3. 第一張圖片同時存入 `photoURL` 欄位作為主圖（向下兼容）。<br>4. 使用 ImageSlider 元件以輪播方式展示多張圖片。 |
| **F-B2** | **使用者資料管理**<br>1. 首次登入後，系統引導使用者前往 `/profile` 頁面設定個人資料。<br>2. 個人資料表單包含：<br>   - 姓名或暱稱（必填）<br>   - 是否為荒野夥伴（選項）<br>   - 團名或分會（荒野夥伴必填）<br>   - 自然名（荒野夥伴必填）<br>3. 使用者可隨時透過 Header 的「個人資料」連結編輯資料。<br>4. 資料儲存於 `users` 集合，以 uid 為鍵。<br>5. 修改後立即重新載入並更新 UI 顯示。 |
| **F-B3** | **回報錯誤**<br>1. 在地點詳情面板 (F-A3) 中，為登入使用者提供「回報錯誤」按鈕。<br>2. 點擊後彈出一個表單，讓使用者填寫問題描述。<br>3. 提交的回報應存入 `reports` 集合。 |
| **F-B4** | **登錄者資訊顯示**<br>1. 地點詳情面板中顯示登錄者資訊區塊。<br>2. 顯示格式：<br>   - 荒野夥伴：「團別-自然名」+🌿標誌<br>   - 一般使用者：顯示名稱<br>3. 資訊以綠色背景區塊突出顯示。 |
| **F-B5** | **使用者編輯自己的地點**<br>1. 登入使用者可透過 Header 的「我的地點」選項查看自己提交的所有地點。<br>2. 採用模態視窗 (Modal) 顯示地點列表。<br>3. 每個地點顯示：<br>   - 名稱、地址、類型圖示<br>   - 標籤列表<br>   - 鎖定狀態標誌（🔒 已鎖定 / 可編輯）<br>4. **編輯權限**：<br>   - 使用者只能編輯**未鎖定**的地點<br>   - 管理員可透過後台「鎖定」地點，防止使用者編輯<br>5. 點擊「編輯」按鈕後，以模態視窗方式顯示編輯表單（類似登錄流程）。<br>6. 編輯後資料直接更新至 `locations` 集合，無需重新審核。<br>7. **操作記錄**：所有編輯操作會自動記錄至 `audit_logs` 集合。 |

## 模組 C: 管理員功能 (Admin)
此為「平台管理員」維護資料品質的後台功能。

| ID   | 功能規格描述 |
| :--- | :--- |
| **F-C1** | **審核待處理地點**<br>1. 提供一個 `/admin/pending` 頁面，顯示 `pending_locations` 集合中的所有文件。<br>2. 顯示登錄者資訊（姓名、荒野夥伴標誌）與地點類型。<br>3. 點擊詳情可查看完整資訊（含動態欄位內容）。<br>4. 提供「核准」與「拒絕」按鈕。<br>5. **核准**: 將文件完整複製到 `locations` 集合，並從 `pending_locations` 刪除。<br>6. **拒絕**: 從 `pending_locations` 刪除文件，並刪除 Storage 中的所有對應圖片。 |
| **F-C2** | **管理回報與資料**<br>1. 提供一個 `/admin/reports` 頁面，顯示 `reports` 集合中的文件。<br>2. **按地點分組顯示**：回報會自動依 `locationId` 分組。<br>3. **視覺化回報數量**：<br>   - 單一回報：黃色標籤<br>   - 多個回報：紅色標籤（需特別注意）<br>4. **可展開/收合介面**：點擊地點標題可展開查看所有回報。<br>5. **分別處理回報**：每個回報獨立顯示，包含：<br>   - 回報編號（#1, #2...）<br>   - 回報時間<br>   - 回報內容<br>   - 獨立的「標示為已解決」按鈕<br>6. **統計摘要**：頁面底部顯示總地點數、總回報數和有多個回報的地點數。<br>7. 篩選功能：可切換「待處理」與「已解決」回報。 |
| **F-C3** | **管理標籤** (`/admin/tags`)<br>1. 提供標籤列表，顯示所有現有標籤。<br>2. 新增標籤：輸入標籤名稱，創建新標籤。<br>3. 編輯標籤：修改標籤名稱。<br>4. 刪除標籤：<br>   - 檢查標籤是否被地點使用<br>   - 若有地點使用，顯示警告並列出使用數量<br>   - 確認後仍可強制刪除<br>5. 所有操作即時更新列表。 |
| **F-C3.1** | **管理地點** (`/admin/locations`)<br>1. 提供地點列表，顯示所有地點（含核准與未核准）。<br>2. **地點資訊顯示**：<br>   - 作者：原始登錄者資訊（來自 `submitterInfo`）<br>   - 最後編輯時間：如果編輯者不同於作者，顯示最後編輯日期<br>3. 新增地點：管理員可直接新增地點（包含多圖片上傳）。<br>4. 編輯地點：修改地點資訊（名稱、地址、描述、標籤、圖片、動態欄位）。<br>   - **保留作者資訊**：編輯時 `createdBy` 和 `createdAt` 維持不變<br>   - **更新編輯者資訊**：自動更新 `updatedBy` 和 `updatedAt`<br>5. **鎖定/解鎖地點**：<br>   - 管理員可鎖定地點，防止原作者編輯<br>   - 地點列表顯示鎖定狀態標誌（🔒 已鎖定 / 🔓 未鎖定）<br>   - 鎖定後，原作者在「我的地點」中無法編輯該地點<br>6. 刪除地點：刪除地點及其 Storage 中的圖片。<br>7. 多圖片管理：<br>   - 使用 ImageSlider 預覽現有圖片<br>   - 可新增或移除圖片<br>   - 最多 10 張圖片<br>8. 地址變更時自動重新進行地理編碼。<br>9. **操作記錄**：所有操作（新增、編輯、刪除、鎖定/解鎖）會自動記錄至 `audit_logs` 集合。 |
| **F-C4** | **超級管理員系統**<br>系統採用「**超級管理員**」(Super Admin) 與「**一般管理員**」(Admin) 兩級權限分離架構。<br>1. **角色定義**:<br>   - `superAdmin`: 最高權限，能夠管理其他管理員帳號<br>   - `admin`: 一般管理員，僅能審核地點、處理回報<br>2. **權限同步**: 後端的雲端函式 `syncAdminStatus` 會自動將 Firestore 中 `admins` 集合的 `role` 欄位同步到 Firebase Auth 的 Custom Claims (`role: 'admin'` 或 `role: 'superAdmin'`)。<br>3. **初始設定**: 預設超級管理員需透過命令列工具 (`setup_nestor_super_admin.cjs`) 或手動操作 Firebase 控制台設定。 |
| **F-C5** | **管理員帳號管理介面** (`/admin/manage-admins`)<br>僅限超級管理員存取的管理員管理頁面，提供以下功能：<br>1. **列出管理員**: 顯示所有管理員的列表，包含 Email、角色、同步狀態。<br>2. **同步狀態檢查**: 即時顯示每個管理員的 Custom Claim 是否與 Firestore 同步。<br>   - ✓ 已同步: Firestore `role` 與 Custom Claim 一致<br>   - ⚠ 未同步: 兩者不一致，顯示「同步權限」按鈕<br>3. **手動同步**: 當同步狀態異常時，超級管理員可點擊「同步權限」按鈕，呼叫 Cloud Function `syncAdminClaim` 手動觸發同步。<br>4. **新增管理員**: 透過網頁表單輸入 Email 地址新增一般管理員，呼叫 Cloud Function `addAdminByEmail`。<br>5. **移除管理員**: 刪除一般管理員（無法刪除超級管理員）。<br>6. **詳細資訊**: 可展開查看每個管理員的完整 Custom Claims 與 Firestore 資料。<br>7. **命令列工具**: 另提供 CLI 工具 (`add_admin.cjs`, `check_user_claims.cjs`) 供離線管理。 |
| **F-C6** | **管理地點類型** (`/admin/types`) [新增]<br>1. **類型管理**: 新增、編輯、刪除地點類型（如：團集會場地）。<br>2. **視覺設定**: 設定類型名稱、描述、圖示 (Emoji) 與標記顏色。<br>3. **動態欄位配置**: <br>   - 支援拖放排序欄位。<br>   - 支援多種欄位類型 (Text, Number, Select, Boolean 等)。<br>   - **數字欄位支援單位設定** (Unit)。<br>   - 設定驗證規則 (必填、最大/最小值等) 與顯示位置 (列表/詳情/地圖)。<br>4. **啟用狀態**: 可切換類型是否啟用，停用後前端使用者將無法選擇。 |
| **F-C7** | **管理使用者** (`/admin/users`)<br>1. 提供使用者列表，顯示所有註冊使用者。<br>2. 顯示資訊：<br>   - Email 地址<br>   - 姓名/暱稱<br>   - 荒野夥伴狀態（🌿 標誌）<br>   - 團名/分會<br>   - 自然名<br>3. **編輯使用者資料**：<br>   - 管理員可編輯使用者的顯示名稱<br>   - 可設定或修改荒野夥伴資訊（團名、自然名）<br>   - Email 地址不可編輯<br>4. **操作記錄**：所有使用者資料變更會記錄至 `audit_logs` 集合。 |
| **F-C8** | **操作記錄系統** (`/admin/audit-logs`)<br>僅限超級管理員存取的操作記錄查看頁面。<br>1. **自動記錄以下操作**：<br>   - 地點操作：核准、拒絕、新增、更新、刪除、鎖定、解鎖<br>   - 使用者操作：更新使用者資料<br>   - 管理員操作：新增管理員、移除管理員<br>   - 使用者自行編輯地點的操作<br>2. **記錄內容**：<br>   - 操作類型（含中文標籤）<br>   - 操作時間（精確到秒）<br>   - 操作者資訊（UID、Email、角色）<br>   - 操作對象（ID、名稱、類型）<br>   - 變更詳情（JSON 格式，可展開查看）<br>3. **篩選功能**：<br>   - 依操作類型篩選<br>   - 依操作者篩選<br>   - 清除篩選選項<br>4. **視覺化**：<br>   - 操作類型以顏色標示（刪除/拒絕=紅色，新增/核准=綠色，更新/鎖定=藍色）<br>   - 角色以顏色標示（超級管理員=紅色，管理員=黃色，使用者=灰色）<br>5. **分頁載入**：每頁顯示 50 筆記錄，支援載入更多。<br>6. **不可變更**：<br>   - 管理員只能新增記錄（寫入權限）<br>   - **任何人都無法修改或刪除記錄**（包括超級管理員）<br>   - 確保稽核追蹤的完整性與可信度 |
