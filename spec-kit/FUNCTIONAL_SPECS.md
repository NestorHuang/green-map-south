# 功能規格書 (Functional Specs)

本文件詳述系統 A, B, C 三大模組的具體功能規格。

## 模組 A: 地圖與搜尋 (Map & Search)
此為使用者查找資訊的核心介面。

| ID   | 功能規格描述 (依據 Q&A 決議) |
| :--- | :--- |
| **F-A1** | **互動地圖初始化**<br> **平台類型**: PWA (Web App)，使用 **Google Maps Platform**。<br> **地圖邏輯**: 必須採用 **GPS 優先** 邏輯。<br> 1. (優先) 請求 `navigator.geolocation` 取得使用者 GPS。<br> 2. (預設) 若失敗，預設中心點為「高雄市火車站」。<br> 3. **縮放尺度**: 初始地圖縮放等級應顯示中心點半徑約 500 公尺的範圍。<br> 4. **API 載入**: Google Maps API 腳本在應用程式啟動時於頂層統一載入，確保跨頁面導航時的穩定性。 |
| **F-A2** | *(待補充)* |
| **F-A3** | **地點詳情互動介面**<br> **模式**: 必須採用「**資訊面板模式 (Bottom Sheet)**」。<br> 1. 使用者點擊地圖上的圖釘 (Pin)。<br> 2. **禁止**彈出傳統小資訊卡或跳轉頁面。<br> 3. 應由螢幕下方滑出「資訊面板」，直接顯示 F-A3 的完整詳情。 |
| **F-A4** | **關鍵字搜尋**<br>1. 在 Header UI 中提供一個文字輸入框。<br>2. 使用 **Google Places Autocomplete** 服務，使用者輸入文字時，動態提供地點建議。<br>3. 使用者選擇地點後，地圖中心點會移動到該地點，並放大顯示。<br>4. **注意**: Google Places Autocomplete 服務目前會顯示棄用警告 (`google.maps.places.Autocomplete is not available to new customers...`)，此為第三方函式庫內部問題，不影響功能，待函式庫更新。 |
| **F-A5** | **分類與標籤篩選**<br>1. 在 Header UI 中提供一組標籤按鈕。<br>2. 點擊標籤按鈕後，地圖應只顯示包含該標籤的地點。<br>3. 需提供「清除篩選」的選項。 |
| **F-A6** | **標記點棄用警告**<br>目前使用的 `google.maps.Marker` 會顯示棄用警告 (`google.maps.Marker is deprecated...`)。此為第三方函式庫內部問題，不影響功能，待函式庫更新或未來版本升級時替換為 `AdvancedMarkerElement`。 |
| **F-A-RWD** | **響應式介面 (RWD)**<br>應用程式的所有核心介面均已進行響應式設計優化。<br>1. **Header**: 在手機版視圖下，導覽選項（如登入、上傳）會收合在一個漢堡選單中，確保搜尋和篩選功能的可見性。<br>2. **管理後台**: 在手機版視圖下，側邊導覽列會預設隱藏，並可透過漢堡選單按鈕喚出，以適應較小的螢幕寬度。 |

## 模組 B: 伙伴貢獻 (Partner Contribution)
此為「綠活伙伴」貢獻資料的核心功能。

| ID   | 功能規格描述 |
| :--- | :--- |
| **F-B1** | **地點登錄**<br>1. 提供一個 `/register` 頁面（原 `/upload`），僅限登入使用者存取。<br>2. 表單應包含：名稱、地址、描述、照片（最多10張）、標籤。<br>3. 系統使用 **Google Maps Geocoding API** 將地址轉換為地理座標。<br>4. 提交的資料會進入 `pending_locations` 集合等待審核，包含完整的登錄者資訊（`submitterInfo`）。<br>5. 使用者必須先完成個人資料設定才能登錄地點。 |
| **F-B1 Auth** | **社交帳號登入**<br>1. 提供 Google 帳號快速登入選項。<br>2. 登入後，UI 應顯示使用者資訊（荒野夥伴顯示為「自然名(團名)」，一般使用者顯示姓名）。<br>3. 提供登出選項與個人資料編輯入口。 |
| **F-B1 Photos**| **多圖片上傳**<br>1. 支援上傳最多 10 張圖片。<br>2. 圖片應上傳至 Firebase Storage，並將所有 URL 存入 `photoURLs` 陣列。<br>3. 第一張圖片同時存入 `photoURL` 欄位作為主圖（向下兼容）。<br>4. 使用 ImageSlider 元件以輪播方式展示多張圖片。 |
| **F-B2** | **使用者資料管理**<br>1. 首次登入後，系統引導使用者前往 `/profile` 頁面設定個人資料。<br>2. 個人資料表單包含：<br>   - 姓名或暱稱（必填）<br>   - 是否為荒野夥伴（選項）<br>   - 團名或分會（荒野夥伴必填）<br>   - 自然名（荒野夥伴必填）<br>3. 使用者可隨時透過 Header 的「個人資料」連結編輯資料。<br>4. 資料儲存於 `users` 集合，以 uid 為鍵。<br>5. 修改後立即重新載入並更新 UI 顯示。 |
| **F-B3** | **回報錯誤**<br>1. 在地點詳情面板 (F-A3) 中，為登入使用者提供「回報錯誤」按鈕。<br>2. 點擊後彈出一個表單，讓使用者填寫問題描述。<br>3. 提交的回報應存入 `reports` 集合。 |
| **F-B4** | **登錄者資訊顯示**<br>1. 地點詳情面板中顯示登錄者資訊區塊。<br>2. 顯示格式：<br>   - 荒野夥伴：「團別-自然名」+🌿標誌<br>   - 一般使用者：顯示名稱<br>3. 資訊以綠色背景區塊突出顯示。 |

## 模組 C: 管理員功能 (Admin)
此為「平台管理員」維護資料品質的後台功能。

| ID   | 功能規格描述 |
| :--- | :--- |
| **F-C1** | **審核待處理地點**<br>1. 提供一個 `/admin/pending` 頁面，顯示 `pending_locations` 集合中的所有文件。<br>2. 顯示登錄者資訊（姓名、荒野夥伴標誌）。<br>3. 提供「核准」與「拒絕」按鈕。<br>4. **核准**: 將文件（包含 submitterInfo）完整複製到 `locations` 集合，並從 `pending_locations` 刪除。<br>5. **拒絕**: 從 `pending_locations` 刪除文件，並刪除 Storage 中的所有對應圖片。<br>6. 支援多圖片預覽（點擊連結開啟新頁面）。 |
| **F-C2** | **管理回報與資料**<br>1. 提供一個 `/admin/reports` 頁面，顯示 `reports` 集合中的文件。<br>2. 提供「標示為已解決」功能，更新文件狀態。 |
| **F-C3** | **管理標籤** (`/admin/tags`)<br>1. 提供標籤列表，顯示所有現有標籤。<br>2. 新增標籤：輸入標籤名稱，創建新標籤。<br>3. 編輯標籤：修改標籤名稱。<br>4. 刪除標籤：<br>   - 檢查標籤是否被地點使用<br>   - 若有地點使用，顯示警告並列出使用數量<br>   - 確認後仍可強制刪除<br>5. 所有操作即時更新列表。 |
| **F-C3.1** | **管理地點** (`/admin/locations`)<br>1. 提供地點列表，顯示所有已核准的地點。<br>2. 新增地點：管理員可直接新增地點（包含多圖片上傳）。<br>3. 編輯地點：修改地點資訊（名稱、地址、描述、標籤、圖片）。<br>4. 刪除地點：刪除地點及其 Storage 中的圖片。<br>5. 多圖片管理：<br>   - 使用 ImageSlider 預覽現有圖片<br>   - 可新增或移除圖片<br>   - 最多 10 張圖片<br>6. 地址變更時自動重新進行地理編碼。 |
| **F-C4** | **超級管理員系統**<br>系統採用「**超級管理員**」(Super Admin) 與「**一般管理員**」(Admin) 兩級權限分離架構。<br>1. **角色定義**:<br>   - `superAdmin`: 最高權限，能夠管理其他管理員帳號<br>   - `admin`: 一般管理員，僅能審核地點、處理回報<br>2. **權限同步**: 後端的雲端函式 `syncAdminStatus` 會自動將 Firestore 中 `admins` 集合的 `role` 欄位同步到 Firebase Auth 的 Custom Claims (`role: 'admin'` 或 `role: 'superAdmin'`)。<br>3. **初始設定**: 預設超級管理員需透過命令列工具 (`setup_nestor_super_admin.cjs`) 或手動操作 Firebase 控制台設定。 |
| **F-C5** | **管理員帳號管理介面** (`/admin/manage-admins`)<br>僅限超級管理員存取的管理員管理頁面，提供以下功能：<br>1. **列出管理員**: 顯示所有管理員的列表，包含 Email、角色、同步狀態。<br>2. **同步狀態檢查**: 即時顯示每個管理員的 Custom Claim 是否與 Firestore 同步。<br>   - ✓ 已同步: Firestore `role` 與 Custom Claim 一致<br>   - ⚠ 未同步: 兩者不一致，顯示「同步權限」按鈕<br>3. **手動同步**: 當同步狀態異常時，超級管理員可點擊「同步權限」按鈕，呼叫 Cloud Function `syncAdminClaim` 手動觸發同步。<br>4. **新增管理員**: 透過網頁表單輸入 Email 地址新增一般管理員，呼叫 Cloud Function `addAdminByEmail`。<br>5. **移除管理員**: 刪除一般管理員（無法刪除超級管理員）。<br>6. **詳細資訊**: 可展開查看每個管理員的完整 Custom Claims 與 Firestore 資料。<br>7. **命令列工具**: 另提供 CLI 工具 (`add_admin.cjs`, `check_user_claims.cjs`) 供離線管理。 |
