rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==================== 輔助函數 ====================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             request.auth.token.role in ['admin', 'superAdmin'];
    }
    
    function isSuperAdmin() {
      return isAuthenticated() && 
             request.auth.token.role == 'superAdmin';
    }
    
    // 驗證 typeId 是否存在
    function typeExists(typeId) {
      return exists(/databases/$(database)/documents/location_types/$(typeId));
    }
    
    // 驗證 dynamicFields 符合 schema
    function validDynamicFields(typeId, dynamicFields) {
      // 注意：Firestore Rules 中無法進行複雜的 schema 驗證
      // 詳細驗證應在 Cloud Functions 或前端進行
      return dynamicFields is map;
    }
    
    
    // ==================== location_types 規則 ====================
    
    match /location_types/{typeId} {
      // 所有人可讀取已啟用的類型
      allow read: if resource.data.isActive == true || isAdmin();

      // 僅管理員可建立和更新
      allow create: if isAdmin() &&
        request.resource.data.keys().hasAll([
          'name', 'icon', 'iconEmoji', 'color',
          'order', 'isActive', 'fieldSchema', 'commonFields'
        ]) &&
        request.resource.data.name is string &&
        request.resource.data.name.size() > 0 &&
        request.resource.data.iconEmoji is string &&
        request.resource.data.color.matches('^#[0-9A-Fa-f]{6}$') &&
        request.resource.data.fieldSchema is list;

      allow update: if isAdmin();

      // 僅超級管理員可刪除
      allow delete: if isSuperAdmin();
      // 注意：刪除前應先檢查使用情況（由前端或 Cloud Function 處理）
    }
    
    
    // ==================== locations 規則 ====================

    match /locations/{locationId} {
      // 所有人可讀取已核准的地點，管理員可讀取所有
      allow read: if resource.data.status == 'approved' || isAdmin();

      // 管理員可完全讀寫
      allow write: if isAdmin();

      // 額外驗證 typeId
      allow create: if isAdmin() &&
        typeExists(request.resource.data.typeId);

      // 使用者可以更新自己提交且未鎖定的地點
      allow update: if (isAdmin() ||
        (isAuthenticated() &&
         resource.data.submitterInfo.uid == request.auth.uid &&
         resource.data.locked != true)) &&
        typeExists(request.resource.data.typeId);
    }
    
    
    // ==================== pending_locations 規則 ====================

    match /pending_locations/{locationId} {
      // 管理員可讀取所有，使用者可讀取自己提交的
      allow read: if isAdmin() ||
                     (isAuthenticated() && resource.data.submitterInfo.uid == request.auth.uid);

      // 登入使用者可建立
      allow create: if isAuthenticated() &&
        request.resource.data.submitterInfo.uid == request.auth.uid &&
        typeExists(request.resource.data.typeId) &&
        validDynamicFields(
          request.resource.data.typeId,
          request.resource.data.dynamicFields
        );

      // 僅管理員可更新和刪除
      allow update, delete: if isAdmin();
    }
    
    
    // ==================== 其他集合規則 ====================
    
    match /tags/{tagId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    match /users/{userId} {
      // 使用者可讀寫自己的資料，管理員可讀取所有使用者資料
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      allow write: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
    }
    
    match /reports/{reportId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }
    
    match /admins/{adminId} {
      allow read: if isAdmin();
      allow write: if isSuperAdmin();
    }

    match /audit_logs/{logId} {
      // 僅超級管理員可讀取操作記錄
      allow read: if isSuperAdmin();
      // 管理員可新增記錄，但任何人都不能修改或刪除
      allow create: if isAdmin();
      allow update, delete: if false;
    }

    match /user_drafts/{userId} {
      // 使用者只能存取自己的草稿
      allow read, write: if isAuthenticated() && request.auth.uid == userId;

      match /location_drafts/{draftId} {
        // 使用者可以讀寫自己的地點草稿
        allow read, write: if isAuthenticated() && request.auth.uid == userId;
      }
    }
  }
}
